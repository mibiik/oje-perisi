// Tatlƒ± Renk ƒ∞simleri Veritabanƒ±
const sweetColorNames = {
    // Pembe tonlarƒ±
    'ffc0cb': 'Pamukku≈üu Pembe',
    'ffb6c1': 'G√ºl Yapraƒüƒ±',
    'ff69b4': 'Balerin Ayakkabƒ±sƒ±',
    'ff1493': 'A≈ük Meleƒüi',
    'db7093': 'Prenses Ayakkabƒ±sƒ±',
    'c71585': 'Unicorn Kalbi',
    'ff91a4': 'Kiraz √ái√ßeƒüi',
    'ffadd6': 'Pamuk ≈ûeker',
    'ff8fa3': 'ƒ∞lk A≈ük',
    
    // Kƒ±rmƒ±zƒ± tonlarƒ±
    'ff0000': 'Ate≈ü Kelebeƒüi',
    'dc143c': 'Kiraz Dudak',
    'b22222': 'A≈ükƒ±n Rengi',
    'cd5c5c': 'G√ºl Gonca',
    'f08080': 'G√ºn Batƒ±mƒ± Kƒ±zƒ±llƒ±ƒüƒ±',
    'fa8072': 'Mercan Adasƒ±',
    'e9967a': 'Tar√ßƒ±n Kƒ±z',
    
    // Turuncu tonlarƒ±
    'ffa500': 'Bal Portakalƒ±',
    'ff8c00': 'Sonbahar Yapraƒüƒ±',
    'ff7f50': 'Mercan Balƒ±ƒüƒ±',
    'ff6347': 'Domates √ái√ßeƒüi',
    'ffd700': 'Altƒ±n Prenses',
    'ffb347': 'Ballƒ± Portakal',
    
    // Sarƒ± tonlarƒ±
    'ffff00': 'G√ºne≈ü I≈üƒ±nƒ±',
    'ffd700': 'Altƒ±n Pul',
    'ffffe0': 'Vanilya Bulut',
    'fffacd': 'Limon Krema',
    'f0e68c': 'Bananlƒ± Puding',
    'daa520': 'Bal Damlasƒ±',
    
    // Ye≈üil tonlarƒ±
    '00ff00': 'Nane ≈ûekeri',
    '32cd32': '√áimlerin Dansƒ±',
    '90ee90': 'Mint Buzu',
    '98fb98': 'Bahar Filizi',
    '00fa9a': 'Deniz K√∂p√ºƒü√º',
    '00ff7f': 'Nergis Ye≈üili',
    '7cfc00': '√áimen Perisi',
    
    // Mavi tonlarƒ±
    '0000ff': 'Prens Mavisi',
    '87ceeb': 'G√∂ky√ºz√º R√ºyasƒ±',
    '87cefa': 'Bulut Dansƒ±',
    '00bfff': 'Okyanus Parƒ±ltƒ±sƒ±',
    '1e90ff': 'Elsa\'nƒ±n Elbisesi',
    '6495ed': 'Mavi Kelebek',
    '4169e1': 'Kraliyet Mavisi',
    
    // Mor tonlarƒ±
    '800080': 'Lavanta Bah√ßesi',
    '9370db': 'Leylak R√ºyasƒ±',
    'ba55d3': 'Orkide √ái√ßeƒüi',
    'dda0dd': 'Menek≈üe Bulutu',
    'ee82ee': 'Mor Kelebek',
    'd8bfd8': 'Thistle Peri',
    '9966cc': 'Ametist Ta≈üƒ±',
    
    // Beyaz tonlarƒ±
    'ffffff': 'Kar Tanesi',
    'fffafa': 'ƒ∞nci Beyazƒ±',
    'f0f8ff': 'Melek T√ºy√º',
    'f5f5dc': 'Vanilya Bulutu',
    'fdf5e6': 'Pudra ≈ûekeri',
    
    // Siyah tonlarƒ±
    '000000': 'Gece Prensesi',
    '2f2f2f': 'K√∂m√ºr Elmasƒ±',
    '696969': 'Fƒ±rtƒ±na Bulutu'
};

// Ger√ßek √úr√ºn Kataloƒüu - Pop√ºler oje √ºr√ºnleri
const realNailProducts = {
    // OPI √úr√ºnleri
    opi: [
        "OPI - Big Apple Red", "OPI - I'm Not a Waitress", "OPI - Bubble Bath", 
        "OPI - Alpine Snow", "OPI - Lincoln Park After Dark", "OPI - Cajun Shrimp",
        "OPI - A-Rose at Dawn Broke in Saigon", "OPI - Pink Flamenco", "OPI - Malaga Wine",
        "OPI - Russian Navy", "OPI - You Only Live Twice", "OPI - Mod About You",
        "OPI - Dating a Royal", "OPI - Got the Blues for Red", "OPI - Purple Palazzo Pants"
    ],
    
    // Essie √úr√ºnleri
    essie: [
        "Essie - Ballet Slippers", "Essie - Mademoiselle", "Essie - Bordeaux", 
        "Essie - Midnight Cami", "Essie - Forever Yummy", "Essie - Cute as a Button",
        "Essie - Lady Godiva", "Essie - Wicked", "Essie - Aruba Blue", "Essie - Mint Candy Apple",
        "Essie - Sand Tropez", "Essie - Lovie Dovie", "Essie - Really Red", "Essie - Go Ginza"
    ],
    
    // Chanel √úr√ºnleri
    chanel: [
        "Chanel - Rouge Noir", "Chanel - Vamp", "Chanel - Rose Confidentiel",
        "Chanel - Ballerina", "Chanel - Dragon", "Chanel - Particuliere",
        "Chanel - Black Pearl", "Chanel - Azure", "Chanel - June"
    ],
    
    // Sally Hansen √úr√ºnleri
    sallyHansen: [
        "Sally Hansen - Red My Lips", "Sally Hansen - Shell We Dance", "Sally Hansen - Barracuda",
        "Sally Hansen - Right Said Red", "Sally Hansen - Pink Pong", "Sally Hansen - Lavender Cloud",
        "Sally Hansen - Mellow Yellow", "Sally Hansen - Black Out", "Sally Hansen - White On"
    ],
    
    // T√ºrk Markalarƒ±
    flormar: [
        "Flormar - Classic Red", "Flormar - Pink Paradise", "Flormar - Nude Beige",
        "Flormar - Deep Purple", "Flormar - Ocean Blue", "Flormar - Coral Dream",
        "Flormar - Berry Kiss", "Flormar - Mint Fresh"
    ],
    
    goldenRose: [
        "Golden Rose - Rich Color 01", "Golden Rose - Rich Color 10", "Golden Rose - Rich Color 22",
        "Golden Rose - Rich Color 45", "Golden Rose - Rich Color 60", "Golden Rose - Rich Color 78"
    ],
    
    pastel: [
        "Pastel - Show Your Color 115", "Pastel - Show Your Color 203", "Pastel - Show Your Color 309",
        "Pastel - Show Your Color 412", "Pastel - Show Your Color 518", "Pastel - Show Your Color 624"
    ]
};

// Marka √∂nerileri
const nailPolishBrands = [
    'Essie', 'OPI', 'Chanel', 'Dior', 'MAC', 'Revlon', 
    'Sally Hansen', 'Zoya', 'China Glaze', 'Nails Inc',
    'Flormar', 'Golden Rose', 'Pastel', 'Rimmel'
];

// Global deƒüi≈ükenler
let currentImage = null;
let geminiApiKey = 'AIzaSyAdGMyunS-Tpty1cCLgMnvTCTbkE5YQfOw';
// Fotoƒüraf bazlƒ± tutarlƒ±lƒ±k i√ßin image fingerprint sistemi
let imageAnalysisCache = {};

// Google Lens API i√ßin SerpApi kullanacaƒüƒ±z (√ºcretsiz)
let serpApiKey = 'demo'; // Kullanƒ±cƒ± demo key ile ba≈ülayabilir

// DOM elementleri
const fileInput = document.getElementById('fileInput');
const uploadBtn = document.getElementById('uploadBtn');
const uploadArea = document.getElementById('uploadArea');
const imagePreview = document.getElementById('imagePreview');
const previewImg = document.getElementById('previewImg');
const changeBtn = document.getElementById('changeBtn');
const analyzeBtn = document.getElementById('analyzeBtn');
const loading = document.getElementById('loading');
const resultsSection = document.getElementById('resultsSection');
const colorsGrid = document.getElementById('colorsGrid');
const errorMessage = document.getElementById('errorMessage');
const errorText = document.getElementById('errorText');

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Dosya y√ºkleme
    uploadBtn.addEventListener('click', () => fileInput.click());
    changeBtn.addEventListener('click', () => fileInput.click());
    
    fileInput.addEventListener('change', handleFileSelect);
    
    // Drag & drop
    uploadArea.addEventListener('dragover', handleDragOver);
    uploadArea.addEventListener('drop', handleDrop);
    uploadArea.addEventListener('dragleave', handleDragLeave);
    
    // Analiz butonu
    analyzeBtn.addEventListener('click', analyzeImage);
    
    // Google Lens API ayarlarƒ± i√ßin ayarlar butonu
    const settingsBtn = document.createElement('button');
    settingsBtn.innerHTML = '‚öôÔ∏è API Ayarlarƒ±';
    settingsBtn.className = 'settings-btn';
    settingsBtn.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(45deg, #ff6b9d, #c44569);
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 20px;
        cursor: pointer;
        font-size: 14px;
        z-index: 1000;
        box-shadow: 0 4px 15px rgba(255, 107, 157, 0.3);
    `;
    settingsBtn.addEventListener('click', showApiSettings);
    document.body.appendChild(settingsBtn);
});

// API ayarlarƒ± modalƒ±
function showApiSettings() {
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 2000;
    `;
    
    modal.innerHTML = `
        <div style="background: white; padding: 30px; border-radius: 20px; max-width: 500px; margin: 20px;">
            <h2 style="color: #ff6b9d; margin-bottom: 20px;">üîß API Ayarlarƒ±</h2>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">SerpApi Anahtarƒ± (Google Lens i√ßin):</label>
                <input type="text" id="serpApiInput" value="${serpApiKey}" placeholder="demo" 
                       style="width: 100%; padding: 10px; border: 2px solid #ffb6c1; border-radius: 10px; font-size: 14px;">
                <small style="color: #666; display: block; margin-top: 5px;">
                    √úcretsiz anahtar i√ßin <a href="https://serpapi.com" target="_blank">serpapi.com</a>'a kayƒ±t olun
                </small>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Gemini API Anahtarƒ±:</label>
                <input type="password" id="geminiApiInput" value="${geminiApiKey}" 
                       style="width: 100%; padding: 10px; border: 2px solid #ffb6c1; border-radius: 10px; font-size: 14px;">
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                        style="padding: 10px 20px; background: #ccc; border: none; border-radius: 10px; cursor: pointer;">
                    ƒ∞ptal
                </button>
                <button onclick="saveApiSettings()" 
                        style="padding: 10px 20px; background: linear-gradient(45deg, #ff6b9d, #c44569); color: white; border: none; border-radius: 10px; cursor: pointer;">
                    Kaydet
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

// API ayarlarƒ±nƒ± kaydet
function saveApiSettings() {
    const serpInput = document.getElementById('serpApiInput');
    const geminiInput = document.getElementById('geminiApiInput');
    
    if (serpInput.value.trim()) {
        serpApiKey = serpInput.value.trim();
        localStorage.setItem('serpApiKey', serpApiKey);
    }
    
    if (geminiInput.value.trim()) {
        geminiApiKey = geminiInput.value.trim();
        localStorage.setItem('geminiApiKey', geminiApiKey);
    }
    
    // Modal'ƒ± kapat
    document.querySelector('[style*="position: fixed"][style*="rgba(0, 0, 0, 0.5)"]').remove();
    
    showSuccess('API ayarlarƒ± kaydedildi! üéâ');
}

// Sayfa y√ºklenirken kaydedilmi≈ü ayarlarƒ± y√ºkle
document.addEventListener('DOMContentLoaded', function() {
    const savedSerpKey = localStorage.getItem('serpApiKey');
    const savedGeminiKey = localStorage.getItem('geminiApiKey');
    
    if (savedSerpKey) serpApiKey = savedSerpKey;
    if (savedGeminiKey) geminiApiKey = savedGeminiKey;
});



// Dosya se√ßme i≈ülemi
function handleFileSelect(event) {
    const file = event.target.files[0];
    if (file && file.type.startsWith('image/')) {
        processImage(file);
    } else {
        showError('L√ºtfen ge√ßerli bir resim dosyasƒ± se√ßin!');
    }
}

// Drag & drop i≈ülemleri
function handleDragOver(event) {
    event.preventDefault();
    uploadArea.style.borderColor = '#ff6b9d';
    uploadArea.style.background = 'linear-gradient(45deg, rgba(255, 182, 193, 0.3), rgba(255, 159, 181, 0.3))';
}

function handleDragLeave(event) {
    event.preventDefault();
    uploadArea.style.borderColor = '#ff9eb5';
    uploadArea.style.background = 'linear-gradient(45deg, rgba(255, 182, 193, 0.1), rgba(255, 159, 181, 0.1))';
}

function handleDrop(event) {
    event.preventDefault();
    handleDragLeave(event);
    
    const files = event.dataTransfer.files;
    if (files.length > 0 && files[0].type.startsWith('image/')) {
        processImage(files[0]);
    } else {
        showError('L√ºtfen ge√ßerli bir resim dosyasƒ± bƒ±rakƒ±n!');
    }
}

// Resim i≈üleme
function processImage(file) {
    currentImage = file;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        previewImg.src = e.target.result;
        showImagePreview();
        hideMessages();
    };
    reader.readAsDataURL(file);
}

function showImagePreview() {
    uploadArea.style.display = 'none';
    imagePreview.style.display = 'block';
}

function hideImagePreview() {
    uploadArea.style.display = 'block';
    imagePreview.style.display = 'none';
    currentImage = null;
}

// Resim analizi
async function analyzeImage() {
    if (!currentImage) {
        showError('L√ºtfen √∂nce bir resim y√ºkleyin!');
        return;
    }
    
    showLoading();
    hideMessages();
    
    // ƒ∞lk √∂nce loading b√∂l√ºm√ºn√º sayfanƒ±n √ºst kƒ±smƒ±na getir (d√º≈ü√ºnme ekranƒ±nƒ± g√∂ster)
    setTimeout(() => {
        document.getElementById('loading').scrollIntoView({ 
            behavior: 'smooth', 
            block: 'center' 
        });
    }, 100);
    
    try {
        // Resmi base64'e √ßevir
        const base64Image = await fileToBase64(currentImage);
        
        // Gemini API'ye istek g√∂nder
        const result = await analyzeImageWithGemini(base64Image);
        
        if (result) {
            if (!result.isNailRelated) {
                // Oje olmayan resim i√ßin tatlƒ± itiraz
                showFairyComplaint(result.fairyComment);
            } else if (result.colors && result.colors.length > 0) {
                displayResults(result);
            } else {
                showError('Resimde oje rengi tespit edilemedi. L√ºtfen daha net bir fotoƒüraf deneyin.');
            }
        } else {
            showError('Analiz sƒ±rasƒ±nda bir hata olu≈ütu. L√ºtfen tekrar deneyin.');
        }
        
    } catch (error) {
        console.error('Analiz hatasƒ±:', error);
        showError('Analiz sƒ±rasƒ±nda bir hata olu≈ütu. L√ºtfen tekrar deneyin.');
    } finally {
        hideLoading();
    }
}

// Dosyayƒ± base64'e √ßevir
function fileToBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
            const base64 = reader.result.split(',')[1];
            resolve(base64);
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
    });
}

// Gemini API ile analiz
async function analyzeImageWithGemini(base64Image) {
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${geminiApiKey}`;
    
    // Fotoƒüraf i√ßin unique ID olu≈ütur (base64'√ºn hash'i)
    const imageId = hashString(base64Image.substring(0, 1000)); // ƒ∞lk 1000 karakter yeterli
    
    // Eƒüer bu fotoƒüraf daha √∂nce analiz edildiyse, aynƒ± sonucu d√∂n
    if (imageAnalysisCache[imageId]) {
        console.log('Cached result kullanƒ±lƒ±yor aynƒ± fotoƒüraf i√ßin');
        return imageAnalysisCache[imageId];
    }
    
    const randomThoughts = [
        "üßö‚Äç‚ôÄÔ∏è Ayyy ne tatlƒ± bir resim! Hemen b√ºy√ºlerimi yapalƒ±m...",
        "‚ú® Vay canƒ±na! Bu tƒ±rnaklarda ne g√ºzel sƒ±rlar var...",
        "üíÖ Aman Tanrƒ±m, bu kadar g√ºzel bir oje g√∂rd√ºm m√º hi√ß?",
        "üå∏ Bu renk tam benim tarzƒ±m! Analiz ediyorum sevgilim...",
        "üíñ Kalbim √ßarpƒ±yor, muhte≈üem bir renk bu! Bulacaƒüƒ±m...",
        "ü¶Ñ Unicorn renklerine benziyor! Hangi b√ºy√º bu b√∂yle?",
        "‚ú® Peri g√∂zlerimle bakƒ±yorum... √áok ≈üirin bir renk!",
        "üåà Bu renk sanki g√∂kku≈üaƒüƒ±ndan d√º≈üm√º≈ü gibi!",
        "üíé Kristal gibi parƒ±ldƒ±yor bu g√ºzellik!",
        "üé® Sanat eseri gibi bir renk! Hemen ismine karar veriyorum...",
        "üå∫ Bu renk sanki bir √ßi√ßek bah√ßesi gibi kokmuyor mu?",
        "üç≠ ≈ûeker gibi tatlƒ± bir renk! Tadƒ±na bakayƒ±m...",
        "üîÆ Sihirli k√ºremde bu rengin hikayesini g√∂r√ºyorum...",
        "üåô Ay ƒ±≈üƒ±ƒüƒ±nda bile bu kadar g√ºzel parƒ±ldamaz!",
        "üé™ B√ºy√ºl√º sirkte bile b√∂yle renkler yok!"
    ];
    
    const randomThought = randomThoughts[Math.floor(Math.random() * randomThoughts.length)];
    
    // Ger√ßek √ºr√ºn listesini JSON string'e √ßevir
    const realProductList = JSON.stringify(realNailProducts);
    
    const prompt = `Sen √ßok tatlƒ± ve sevimli bir "Oje Perisi"sin! ${randomThought}

üéØ √ñNEMLƒ∞ KURALLAR:
1. Bu AYNI fotoƒüraf i√ßin her zaman AYNI isimleri ver (fotoƒüraf bazlƒ± tutarlƒ±lƒ±k)
2. Aynƒ± fotoƒüraf = aynƒ± renk isimleri (deƒüi≈ümez!)
3. **SADECE A≈ûAƒûIDAKƒ∞ GER√áEK √úR√úN Lƒ∞STESƒ∞NDEN** se√ß - rastgele √ºr√ºn uydurmak yasak!
4. HEX kodlarƒ± kesin ve doƒüru olmalƒ±
5. Her renk i√ßin tam 3 adet ger√ßek √ºr√ºn √∂ner
6. √úr√ºn isimleri birebir a≈üaƒüƒ±daki listeden alƒ±nmalƒ±

üìã GER√áEK √úR√úN KATALOƒûU (SADECE BUNLARDAN SE√á):
${realProductList}

Bu resmi analiz et. Eƒüer resimde oje, tƒ±rnak, nail art veya tƒ±rnak cilasƒ± varsa:
- Renkleri tespit et ve HEX kodlarƒ±nƒ± ver
- Her renk i√ßin tatlƒ± isim ver (bu fotoƒüraf i√ßin sabit isimler)
- Tatlƒ± bir yorum ekle
- **MUTLAKa yukarƒ±daki ger√ßek √ºr√ºn listesinden** en uyumlu 3 √ºr√ºn se√ß
- Hem yerli (Flormar, Golden Rose, Pastel) hem yabancƒ± markalar karƒ±≈üƒ±k √∂ner
- Fiyat aralƒ±ƒüƒ± dengeli olsun (ucuz + orta + pahalƒ±)

√úR√úN SE√áƒ∞M KURALLARI:
- Kƒ±rmƒ±zƒ± tonlarƒ± ‚Üí OPI Big Apple Red, Essie Really Red, Chanel Rouge Noir gibi
- Pembe tonlarƒ± ‚Üí OPI Pink Flamenco, Essie Ballet Slippers, Flormar Pink Paradise gibi  
- Siyah tonlarƒ± ‚Üí OPI Lincoln Park After Dark, Chanel Vamp, Sally Hansen Black Out gibi
- Her renk i√ßin farklƒ± markalardan se√ß (3 √ºr√ºn = 3 farklƒ± marka)

Eƒüer resimde oje/tƒ±rnak YOKSA, ≈üu tarzda tatlƒ± itirazlar et:
- "Ayy ama bu oje deƒüil ki! Bana g√ºzel bir oje resmi ver üíÖ"
- "Hmm, burada tƒ±rnak g√∂remiyorum ben! Oje nerde? ü§î"
- "Bu √ßok g√ºzel ama oje arƒ±yorum ben! Tƒ±rnak resmi istiyorum üßö‚Äç‚ôÄÔ∏è"

Cevabƒ±n JSON formatƒ±nda olsun:
{
    "isNailRelated": true/false,
    "fairyComment": "Oje perisinin tatlƒ± yorumu",
    "colors": [
        {
            "hex": "#FF69B4", 
            "description": "parlak pembe",
            "fairyName": "A≈ük Meleƒüi Pembesi",
            "comment": "Bu renk tam bir prenses rengi!",
            "suggestedBrands": ["OPI - Pink Flamenco", "Essie - Lovie Dovie", "Flormar - Pink Paradise"]
        }
    ]
}`;
    
    const response = await fetch(apiUrl, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            contents: [{
                parts: [
                    { text: prompt },
                    {
                        inline_data: {
                            mime_type: "image/jpeg",
                            data: base64Image
                        }
                    }
                ]
            }]
        })
    });
    
    if (!response.ok) {
        throw new Error(`API Hatasƒ±: ${response.status}`);
    }
    
    const data = await response.json();
    
    if (data.candidates && data.candidates[0] && data.candidates[0].content) {
        const text = data.candidates[0].content.parts[0].text;
        
        try {
            const jsonMatch = text.match(/\{[\s\S]*\}/);
            if (jsonMatch) {
                const result = JSON.parse(jsonMatch[0]);
                
                // Sonucu cache'e kaydet (aynƒ± fotoƒüraf i√ßin tutarlƒ±lƒ±k)
                imageAnalysisCache[imageId] = result;
                
                return result;
            }
        } catch (e) {
            console.error('JSON parse hatasƒ±:', e);
        }
    }
    
    return null;
}

// String i√ßin basit hash function (fotoƒüraf ID'si i√ßin)
function hashString(str) {
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
        const char = str.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash; // 32-bit integer'a √ßevir
    }
    return hash.toString();
}

// Sonu√ßlarƒ± g√∂ster
function displayResults(result) {
    colorsGrid.innerHTML = '';
    
    // Oje perisi yorumu ekle
    if (result.fairyComment) {
        const commentDiv = document.createElement('div');
        commentDiv.className = 'fairy-comment';
        commentDiv.innerHTML = `
            <i class="fas fa-user-secret fairy-avatar"></i>
            <div class="fairy-text">${result.fairyComment}</div>
        `;
        colorsGrid.appendChild(commentDiv);
    }
    
    result.colors.forEach(color => {
        const colorItem = createColorItem(color);
        colorsGrid.appendChild(colorItem);
    });
    
    resultsSection.style.display = 'block';
    // Daha yumu≈üak ve ortalanmƒ±≈ü kaydƒ±rma
    setTimeout(() => {
        resultsSection.scrollIntoView({ 
            behavior: 'smooth', 
            block: 'start' 
        });
    }, 300); // 300ms bekleyip kaydƒ±r
}

// Oje olmayan resimler i√ßin tatlƒ± itiraz
function showFairyComplaint(complaint) {
    colorsGrid.innerHTML = '';
    
    const complaintDiv = document.createElement('div');
    complaintDiv.className = 'fairy-complaint';
    complaintDiv.innerHTML = `
        <i class="fas fa-user-secret fairy-avatar big"></i>
        <div class="complaint-text">${complaint}</div>
        <div class="complaint-suggestion">L√ºtfen bana g√ºzel bir oje resmi g√∂ster! üíÖ‚ú®</div>
    `;
    colorsGrid.appendChild(complaintDiv);
    
    resultsSection.style.display = 'block';
    // Daha yumu≈üak ve ortalanmƒ±≈ü kaydƒ±rma
    setTimeout(() => {
        resultsSection.scrollIntoView({ 
            behavior: 'smooth', 
            block: 'start' 
        });
    }, 300); // 300ms bekleyip kaydƒ±r
}

// Renk item'ƒ± olu≈ütur
function createColorItem(color) {
    const div = document.createElement('div');
    div.className = 'color-item';
    
    // Tutarlƒ± isim kullan - AI'dan gelen varsa onu, yoksa kendi sistemimizden
    const sweetName = color.fairyName || getSweetColorName(color.hex);
    
    // Marka √∂nerilerini g√ºzelce formatla
    let brands;
    if (color.suggestedBrands && color.suggestedBrands.length > 0) {
        brands = color.suggestedBrands.slice(0, 3).join('<br>'); // Max 3 √∂neri
    } else {
        // Google Lens API veya akƒ±llƒ± √ºr√ºn √∂nerisi kullan
        const smartSuggestions = getSmartProductSuggestions(color.hex);
        brands = smartSuggestions.join('<br>');
        
        // Arka planda Google Lens API ile daha doƒüru √∂neriler getir
        searchProductsWithGoogleLens(currentImage ? null : null, color.hex)
            .then(lensResults => {
                if (lensResults && lensResults.length > 0) {
                    const brandDiv = div.querySelector('.color-brands');
                    if (brandDiv) {
                        brandDiv.innerHTML = `üíÖ En Uyumlu √ñneriler:<br>${lensResults.join('<br>')}`;
                    }
                }
            })
            .catch(error => console.log('Google Lens API g√ºncelleme hatasƒ±:', error));
    }
    
    div.innerHTML = `
        <div class="color-circle" style="background-color: ${color.hex}"></div>
        <div class="color-name">${sweetName}</div>
        <div class="color-comment">${color.comment || '‚ú® Bu renk √ßok g√ºzel!'}</div>
        <div class="color-code">${color.hex.toUpperCase()}</div>
        <div class="color-brands">üíÖ En Uyumlu √ñneriler:<br>${brands}</div>
    `;
    
    // Tƒ±klama ile renk kodunu kopyala
    div.addEventListener('click', () => {
        copyToClipboard(color.hex);
        showSuccess(`${sweetName} renk kodu kopyalandƒ±! üíÖ`);
    });
    
    return div;
}

// Tutarlƒ± renk ismi al - aynƒ± renk her zaman aynƒ± isim
function getSweetColorName(hex) {
    // HEX'i normalize et
    const normalizedHex = hex.toLowerCase().replace('#', '');
    
    // √ñnce tam e≈üle≈üme ara
    if (sweetColorNames[normalizedHex]) {
        return sweetColorNames[normalizedHex];
    }
    
    // Benzer renk ara ama tutarlƒ±lƒ±k i√ßin aynƒ± algoritma kullan
    const targetColor = hexToRgb(normalizedHex);
    let closestColor = null;
    let minDistance = Infinity;
    let closestHex = null;
    
    for (const [colorHex, name] of Object.entries(sweetColorNames)) {
        const color = hexToRgb(colorHex);
        const distance = colorDistance(targetColor, color);
        
        if (distance < minDistance) {
            minDistance = distance;
            closestColor = name;
            closestHex = colorHex;
        }
    }
    
    // Bulunan en yakƒ±n rengi veritabanƒ±na ekle (tutarlƒ±lƒ±k i√ßin)
    if (closestColor && minDistance < 50) {
        sweetColorNames[normalizedHex] = closestColor;
        return closestColor;
    }
    
    // Yeni unique renk i√ßin tutarlƒ± isim olu≈ütur
    const uniqueName = generateUniqueColorName(normalizedHex);
    sweetColorNames[normalizedHex] = uniqueName;
    return uniqueName;
}

// Yeni renkler i√ßin tutarlƒ± unique isim olu≈ütur
function generateUniqueColorName(hex) {
    const colorWords = [
        'A≈ük', 'R√ºya', 'Melek', 'Prenses', 'Unicorn', 'Peri', 'Yƒ±ldƒ±z', 'Kristal',
        'G√ºl', 'Orkide', 'Lavanta', 'Menek≈üe', 'Kiraz', '≈ûeftali', 'Vanilya',
        'Elmas', 'ƒ∞nci', 'Mercan', 'Yakut', 'Safir', 'Ametist'
    ];
    
    const suffixes = [
        'I≈üƒ±ƒüƒ±', 'Parƒ±ltƒ±sƒ±', 'B√ºy√ºs√º', 'R√ºyasƒ±', 'Melodisi', 'Dansƒ±', 
        'Sƒ±rrƒ±', 'Hikayesi', 'Masalƒ±', '√ñp√ºc√ºƒü√º'
    ];
    
    // HEX'ten deterministic index olu≈ütur (her zaman aynƒ± sonu√ß)
    const hexSum = hex.split('').reduce((sum, char) => sum + char.charCodeAt(0), 0);
    const wordIndex = hexSum % colorWords.length;
    const suffixIndex = (hexSum * 7) % suffixes.length;
    
    return `${colorWords[wordIndex]} ${suffixes[suffixIndex]}`;
}

// Hex'i RGB'ye √ßevir
function hexToRgb(hex) {
    const r = parseInt(hex.substr(0, 2), 16);
    const g = parseInt(hex.substr(2, 2), 16);
    const b = parseInt(hex.substr(4, 2), 16);
    return { r, g, b };
}

// Renk mesafesi hesapla
function colorDistance(color1, color2) {
    const dr = color1.r - color2.r;
    const dg = color1.g - color2.g;
    const db = color1.b - color2.b;
    return Math.sqrt(dr * dr + dg * dg + db * db);
}

// Google Lens API ile ger√ßek √ºr√ºn arama
async function searchProductsWithGoogleLens(imageBase64, colorHex) {
    try {
        // √ñnce renk tabanlƒ± arama terimleri olu≈ütur
        const searchTerms = generateSearchTermsFromColor(colorHex);
        
        // Google Lens Products API (SerpApi √ºzerinden)
        const apiUrl = `https://serpapi.com/search.json?engine=google_lens&search_type=products&api_key=${serpApiKey}`;
        
        // Demo i√ßin sim√ºle edilmi≈ü sonu√ß d√∂nd√ºr (ger√ßek API olmadƒ±ƒüƒ± i√ßin)
        // Ger√ßek kullanƒ±mda a≈üaƒüƒ±daki kodu aktif et:
        /*
        const formData = new FormData();
        formData.append('url', `data:image/jpeg;base64,${imageBase64}`);
        
        const response = await fetch(apiUrl, {
            method: 'POST',
            body: formData
        });
        
        if (response.ok) {
            const data = await response.json();
            return parseGoogleLensResults(data, colorHex);
        }
        */
        
        // Demo i√ßin akƒ±llƒ± √∂neriler d√∂nd√ºr
        return getSmartProductSuggestions(colorHex);
        
    } catch (error) {
        console.error('Google Lens API Hatasƒ±:', error);
        return getSmartProductSuggestions(colorHex);
    }
}

// Renk bazƒ±ndan arama terimlerini olu≈ütur
function generateSearchTermsFromColor(hexColor) {
    const hex = hexColor.toLowerCase().replace('#', '');
    const rgb = hexToRgb(hex);
    
    // Renk kategorisi belirleme
    let colorName = 'neutral';
    let searchTerms = [];
    
    if (rgb.r > 200 && rgb.g < 100 && rgb.b < 100) {
        colorName = 'red';
        searchTerms = ['red nail polish', 'kƒ±rmƒ±zƒ± oje', 'rouge vernis'];
    } else if (rgb.r > 200 && rgb.g > 150 && rgb.b > 150) {
        colorName = 'pink';
        searchTerms = ['pink nail polish', 'pembe oje', 'rose vernis'];
    } else if (rgb.r < 50 && rgb.g < 50 && rgb.b < 50) {
        colorName = 'black';
        searchTerms = ['black nail polish', 'siyah oje', 'noir vernis'];
    } else if (rgb.r > 200 && rgb.g > 200 && rgb.b > 200) {
        colorName = 'white';
        searchTerms = ['white nail polish', 'beyaz oje', 'blanc vernis'];
    } else if (rgb.r < 100 && rgb.g < 100 && rgb.b > 150) {
        colorName = 'blue';
        searchTerms = ['blue nail polish', 'mavi oje', 'bleu vernis'];
    } else if (rgb.r > 100 && rgb.g < 100 && rgb.b > 150) {
        colorName = 'purple';
        searchTerms = ['purple nail polish', 'mor oje', 'violet vernis'];
    }
    
    return { colorName, searchTerms };
}

// Google Lens sonu√ßlarƒ±nƒ± parse et
function parseGoogleLensResults(data, colorHex) {
    const results = [];
    
    if (data.visual_matches) {
        data.visual_matches.slice(0, 3).forEach(match => {
            if (match.title && match.source && match.price) {
                results.push(`${match.source} - ${match.title} (${match.price})`);
            }
        });
    }
    
    // Eƒüer yeterli sonu√ß yoksa fallback kullan
    if (results.length < 3) {
        const fallback = getSmartProductSuggestions(colorHex);
        return [...results, ...fallback.slice(0, 3 - results.length)];
    }
    
    return results;
}

// Renk bazlƒ± akƒ±llƒ± √ºr√ºn √∂nerisi (Fallback sistem)
function getSmartProductSuggestions(hexColor) {
    const hex = hexColor.toLowerCase().replace('#', '');
    const rgb = hexToRgb(hex);
    
    // Renk kategorisi belirleme
    let category = 'neutral';
    if (rgb.r > 200 && rgb.g < 100 && rgb.b < 100) category = 'red';
    else if (rgb.r > 200 && rgb.g > 150 && rgb.b > 150) category = 'pink';
    else if (rgb.r < 50 && rgb.g < 50 && rgb.b < 50) category = 'black';
    else if (rgb.r > 200 && rgb.g > 200 && rgb.b > 200) category = 'white';
    else if (rgb.r < 100 && rgb.g < 100 && rgb.b > 150) category = 'blue';
    else if (rgb.r > 100 && rgb.g < 100 && rgb.b > 150) category = 'purple';
    else if (rgb.r < 100 && rgb.g > 150 && rgb.b < 100) category = 'green';
    else if (rgb.r > 200 && rgb.g > 150 && rgb.b < 100) category = 'orange';
    else if (rgb.r > 200 && rgb.g > 200 && rgb.b < 100) category = 'yellow';
    
    // Kategori bazlƒ± √ºr√ºn √∂nerileri (ger√ßek e-ticaret linkleri ile zenginle≈ütirilmi≈ü)
    const suggestions = {
        red: [
            "üõí OPI - Big Apple Red (Sephora)",
            "üõí Essie - Really Red (Trendyol)", 
            "üõí Chanel - Rouge Noir (Douglas)"
        ],
        pink: [
            "üõí OPI - Pink Flamenco (Sephora)",
            "üõí Essie - Ballet Slippers (Hepsiburada)",
            "üõí Flormar - Pink Paradise (Watsons)"
        ],
        black: [
            "üõí OPI - Lincoln Park After Dark (Sephora)",
            "üõí Chanel - Vamp (Douglas)",
            "üõí Sally Hansen - Black Out (Gratis)"
        ],
        white: [
            "üõí OPI - Alpine Snow (Sephora)",
            "üõí Essie - Mademoiselle (Trendyol)",
            "üõí Flormar - White Dream (Watsons)"
        ],
        blue: [
            "üõí OPI - Russian Navy (Sephora)",
            "üõí Essie - Aruba Blue (Hepsiburada)",
            "üõí Sally Hansen - Blue Me Away (Gratis)"
        ],
        purple: [
            "üõí OPI - Purple Palazzo Pants (Sephora)",
            "üõí Essie - Wicked (Trendyol)",
            "üõí Golden Rose - Rich Color 45 (Watsons)"
        ],
        green: [
            "üõí Essie - Mint Candy Apple (Hepsiburada)",
            "üõí Flormar - Mint Fresh (Watsons)",
            "üõí OPI - Mod About You (Sephora)"
        ],
        orange: [
            "üõí OPI - Cajun Shrimp (Sephora)",
            "üõí Sally Hansen - Orange You Cute (Gratis)",
            "üõí Flormar - Coral Dream (Watsons)"
        ],
        yellow: [
            "üõí Sally Hansen - Mellow Yellow (Gratis)",
            "üõí Golden Rose - Rich Color 22 (Watsons)",
            "üõí Pastel - Show Your Color 309 (Trendyol)"
        ],
        neutral: [
            "üõí OPI - Bubble Bath (Sephora)",
            "üõí Essie - Sand Tropez (Hepsiburada)",
            "üõí Flormar - Nude Beige (Watsons)"
        ]
    };
    
    return suggestions[category] || suggestions.neutral;
}

// Rastgele marka √∂nerisi (fallback)
function getRandomBrands() {
    const shuffled = [...nailPolishBrands].sort(() => 0.5 - Math.random());
    return shuffled.slice(0, 3).join(', ');
}

// Panoya kopyala
function copyToClipboard(text) {
    if (navigator.clipboard) {
        navigator.clipboard.writeText(text);
    } else {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
    }
}

// UI durumlarƒ±
function showLoading() {
    const loadingMessages = [
        "üßö‚Äç‚ôÄÔ∏è Peri b√ºy√º yaparken... Sabƒ±r tatlƒ±m!",
        "‚ú® Renklerin gizli dilini √ß√∂z√ºyorum...",
        "üíÖ Ayyy bu ne g√ºzel bir tƒ±rnak! ƒ∞nceliyorum...",
        "üå∏ Hmm... Bu hangi tatlƒ± renk acaba?",
        "üíñ Kalbim hƒ±zlandƒ±, bu √ßok g√ºzel bir renk!",
        "ü¶Ñ Sihirli g√∂z bebeƒüim √ßalƒ±≈üƒ±yor ≈üu an...",
        "‚ú® Bu g√ºzellik i√ßin en tatlƒ± ismi buluyorum...",
        "üé® Renk paletime bakƒ±yorum... Bir dakika!",
        "üí´ Yƒ±ldƒ±zlardan bilgi alƒ±yorum bekle...",
        "üåà G√∂kku≈üaƒüƒ±nƒ±n hangi tonu bu acaba?",
        "üß™ Sihirli laboratuvarƒ±mda karƒ±≈ütƒ±rƒ±yorum...",
        "üîÆ Kristal k√ºremde g√∂rmeye √ßalƒ±≈üƒ±yorum...",
        "üå∫ Bu renk bana bir √ßi√ßeƒüi hatƒ±rlatƒ±yor...",
        "üíé Deƒüerli ta≈ülarƒ±n arasƒ±nda arƒ±yorum...",
        "üé™ B√ºy√ºl√º sirkte hangi renk bu?",
        "üç≠ ≈ûeker renklerinde e≈üle≈ütiriyorum...",
        "üåô Ay ƒ±≈üƒ±ƒüƒ±nda rengin ger√ßek adƒ±nƒ± g√∂r√ºyorum...",
        "üé≠ Maskenin ardƒ±ndaki ger√ßek rengi buluyorum...",
        "üßö‚Äç‚ôÄÔ∏è Peri tozum biraz daha lazƒ±m... Bekle!",
        "‚ú® Sihirli deƒüneƒüimi sallƒ±yorum ≈üu an..."
    ];
    
    const loadingEmojis = [
        "üíñüí´‚ú®", "üå∏üßö‚Äç‚ôÄÔ∏èüíï", "ü¶Ñüåàüíé", "üé≠üé®üå∫", "üîÆüí´‚≠ê", 
        "üç≠üåôüíñ", "‚ú®üé™üå∏", "üíéü¶ãüåà", "üßö‚Äç‚ôÄÔ∏èüíï‚ú®", "üå∫üí´üé®"
    ];
    
    const randomMessage = loadingMessages[Math.floor(Math.random() * loadingMessages.length)];
    const randomEmojis = loadingEmojis[Math.floor(Math.random() * loadingEmojis.length)];
    
    document.getElementById('loadingText').innerHTML = `
        ${randomMessage}<br>
        <small style="opacity: 0.7; font-size: 0.9rem; margin-top: 5px; display: block;">${randomEmojis}</small>
    `;
    
    loading.style.display = 'block';
    resultsSection.style.display = 'none';
}

function hideLoading() {
    loading.style.display = 'none';
}

function showError(message) {
    errorText.textContent = message;
    errorMessage.style.display = 'block';
    setTimeout(() => {
        errorMessage.style.display = 'none';
    }, 5000);
}

function showSuccess(message) {
    // Ba≈üarƒ± mesajƒ± i√ßin ge√ßici bir element olu≈ütur
    const successDiv = document.createElement('div');
    successDiv.className = 'success-message';
    successDiv.style.cssText = `
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: linear-gradient(45deg, #a8e6cf, #88d8a3);
        color: white;
        padding: 15px 25px;
        border-radius: 15px;
        z-index: 1001;
        box-shadow: 0 5px 20px rgba(168, 230, 207, 0.3);
        font-weight: 600;
    `;
    successDiv.textContent = message;
    
    document.body.appendChild(successDiv);
    
    setTimeout(() => {
        successDiv.remove();
    }, 3000);
}

function hideMessages() {
    errorMessage.style.display = 'none';
    resultsSection.style.display = 'none';
} 